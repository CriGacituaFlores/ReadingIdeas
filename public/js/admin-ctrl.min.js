"use strict";var adpp=angular.module("Admin",["ui.bootstrap","ui.multiselect","nvd3","timer","ui-notification","ngQuill","ngMap"]),DASHBOARD_AUTOREALOD=!0,DASHBOARD_AUTOREALOD_TIME=15;adpp.config(["ngQuillConfigProvider",function(g){g.set({modules:{formula:!0,toolbar:{container:[["bold","italic","underline","strike"],[{color:[]},{background:[]}],[{font:[]}],[{align:[]}],[{list:"ordered"},{list:"bullet"}],[{script:"sub"},{script:"super"}],[{size:["small",!1,"large","huge"]}],["clean"],["image","link","video"],["formula"],["map"]],handlers:{map:quillMapHandler}}}})}]),adpp.controller("AdminController",function(g,h,l,m,o){var w=g;w.temp="",o.NUMBER_FORMATS.GROUP_SEP="",w.shared={},w.sessions=[],w.selectedSes=null,w.documents=[],w.questions=[],w.questionTexts=[],w.newUsers=[],w.users={},w.selectedId=-1,w.sesStatusses=["No Publicada","Lectura","Personal","An\xF3nimo","Grupal","Finalizada"],w.optConfidence=[0,25,50,75,100],w.iterationNames=[],w.openSidebar=!0,w.init=function(){w.shared.updateSesData()},w.selectSession=function(x,y){w.selectedId=y,w.selectedSes=x,w.requestDocuments(),w.requestSemDocuments(),w.requestQuestions(),w.getNewUsers(),w.getMembers(),w.shared.verifyGroups(),w.shared.resetGraphs(),w.shared.verifyTabs(),w.shared.resetTab(),m.path(w.selectedSes.id)},w.shared.updateSesData=function(){h({url:"get-session-list",method:"post"}).success(function(x){if(console.log("Session data updated"),w.sessions=x,-1!=w.selectedId){var y=w.sessions.find(function(z){return z.id==w.selectedId});null!=y&&w.selectSession(y,w.selectedId)}else w.sesFromURL()})},w.sesFromURL=function(){var x=+m.path().substring(1),y=w.sessions.find(function(z){return z.id==x});null!=y&&w.selectSession(y,x)},w.requestDocuments=function(){var x={sesid:w.selectedSes.id};h({url:"documents-session",method:"post",data:x}).success(function(y){w.documents=y})},w.shared.updateDocuments=w.requestDocuments,w.deleteDocument=function(x){h({url:"delete-document",method:"post",data:{docid:x}}).success(function(){w.requestDocuments()})},w.requestQuestions=function(){var x={sesid:w.selectedSes.id};h({url:"questions-session",method:"post",data:x}).success(function(y){w.questions=y.map(function(z){return z.options=z.options.split("\n"),z})}),h({url:"get-question-text",method:"post",data:x}).success(function(y){w.questionTexts=y})},w.requestSemDocuments=function(){var x={sesid:w.selectedSes.id};h({url:"semantic-documents",method:"post",data:x}).success(function(y){w.semDocs=y})},w.getNewUsers=function(){var x={sesid:w.selectedSes.id};h({url:"get-new-users",method:"post",data:x}).success(function(y){w.newUsers=y})},w.getMembers=function(){var x={sesid:w.selectedSes.id};h({url:"get-ses-users",method:"post",data:x}).success(function(y){w.usersArr=y,w.users={},y.forEach(function(z){w.users[z.id]=z})})},w.openNewSes=function(){l.open({templateUrl:"templ/new-ses.html"})},w.openDuplicateSes=function(){if(null!=w.selectedSes){var x=angular.copy(w.selectedSes);l.open({templateUrl:"templ/duplicate-ses.html",controller:"DuplicateSesModalController",controllerAs:"vm",scope:w,resolve:{data:function data(){return x}}})}},w.toggleSidebar=function(){w.openSidebar=!w.openSidebar,w.shared.updateState()},w.init()}),adpp.controller("TabsController",function(g){var l=g;l.tabOptions=["Descripci\xF3n","Dashboard"],l.tabConfig=["Usuarios","Grupos"],l.selectedTab=0,l.selectedTabConfig=-1,l.shared.resetTab=function(){l.selectedTab=0,null!=l.selectedSes&&1<l.selectedSes.status&&(l.selectedTab=1),l.selectedTabConfig=-1,7==l.selectedSes.status&&l.shared.gotoRubrica()},l.shared.verifyTabs=function(){"L"==l.selectedSes.type?(l.iterationNames=[{name:"Lectura",val:0},{name:"Individual",val:1},{name:"Grupal an\xF3nimo",val:2},{name:"Grupal",val:3},{name:"Reporte",val:4},{name:"Calibraci\xF3n Rubrica",val:5},{name:"Evaluaci\xF3n de Pares",val:6}],l.tabOptions=["Configuraci\xF3n","Dashboard"],l.tabConfig=["Usuarios","Grupos","R\xFAbrica"],l.sesStatusses=["Configuraci\xF3n","Lectura","Individual","An\xF3nimo","Grupal","Reporte","Rubrica Calibraci\xF3n","Evaluaci\xF3n de Pares","Finalizada"],l.shared.getRubrica(),l.shared.getExampleReports(),l.shared.getReports()):"S"==l.selectedSes.type?(l.iterationNames=[{name:"Individual",val:1},{name:"Grupal an\xF3nimo",val:2},{name:"Grupal",val:3}],l.tabOptions=["Configuraci\xF3n","Dashboard"],l.tabConfig=["Usuarios","Grupos",null,"Opciones"],l.sesStatusses=["Configuraci\xF3n","Individual","An\xF3nimo","Grupal","Finalizada"]):"M"==l.selectedSes.type&&(l.iterationNames=[{name:"Individual",val:1},{name:"Grupal",val:3},{name:"Reporte",val:4},{name:"Evaluaci\xF3n de Pares",val:6}],l.tabOptions=["Configuraci\xF3n","Dashboard"],l.tabConfig=["Usuarios","Grupos","R\xFAbrica"],l.sesStatusses=[{i:-1,name:"Configuraci\xF3n"},{i:1,name:"Individual"},{i:3,name:"Grupal"},{i:4,name:"Reporte"},{i:6,name:"Evaluaci\xF3n de Pares"},{i:7,name:"Finalizada"}],l.shared.getRubrica(),l.shared.getExampleReports(),l.shared.getReports()),1<l.selectedSes.status&&(l.selectedTab=1)},l.setTab=function(m){l.selectedTab=m},l.setTabConfig=function(m){l.selectedTabConfig=m},l.shared.gotoGrupos=function(){l.selectedTab=0,l.selectedTabConfig=1},l.shared.gotoRubrica=function(){l.selectedTab=0,l.selectedTabConfig=2}}),adpp.controller("DocumentsController",function(g,h,l,m){var o=g;o.busy=!1,o.uploadDocument=function(w){o.busy=!0;var x=new FormData(w.target);h.post("upload-file",x,{transformRequest:angular.identity,headers:{"Content-Type":void 0}}).success(function(y){"ok"==y.status&&m(function(){l.success("Documento cargado correctamente"),w.target.reset(),o.busy=!1,o.shared.updateDocuments()},2e3)})}}),adpp.controller("SesEditorController",function(g,h,l){var m=g;m.mTransition={1:3,3:5,5:6,6:8,8:9},m.splitDescr=!1,m.splDes1="",m.splDes2="",m.toggleSplit=function(){m.splitDescr=!m.splitDescr,m.splitDescr?(m.splDes1=m.selectedSes.descr.split("\n")[0],m.splDes2=m.selectedSes.descr.split("\n")[1]||""):m.selectedSes.descr=m.splDes1+"\n"+m.splDes2},m.updateSession=function(){if(m.splitDescr&&(m.selectedSes.descr=m.splDes1+"\n"+m.splDes2),3>m.selectedSes.name.length||5>m.selectedSes.descr.length)return void l.error("Datos de la sesi\xF3n incorrectos o incompletos");var o={name:m.selectedSes.name,descr:m.selectedSes.descr,id:m.selectedSes.id};h({url:"update-session",method:"post",data:o}).success(function(){console.log("Session updated")})},m.shared.changeState=function(){if("M"!=m.selectedSes.type&&m.selectedSes.status>=m.sesStatusses.length)return void l.error("La sesi\xF3n est\xE1 finalizada");if("M"==m.selectedSes.type&&9<=m.selectedSes.status)return void l.error("La sesi\xF3n est\xE1 finalizada");if("L"==m.selectedSes.type&&3<=m.selectedSes.status&&!m.selectedSes.grouped||"M"==m.selectedSes.type&&3<=m.selectedSes.status&&!m.selectedSes.grouped||"S"==m.selectedSes.type&&2<=m.selectedSes.status&&!m.selectedSes.grouped)return m.shared.gotoGrupos(),void l.error("Los grupos no han sido generados");if("L"==m.selectedSes.type&&7<=m.selectedSes.status&&!m.selectedSes.paired||"M"==m.selectedSes.type&&6<=m.selectedSes.status&&!m.selectedSes.paired)return m.shared.gotoRubrica(),void l.error("Los pares para la evaluaci\xF3n de pares no han sido asignados");var o=window.confirm("\xBFEsta seguro que quiere ir al siguiente estado?");if(o)if("M"==m.selectedSes.type){var w={sesid:m.selectedSes.id,state:m.mTransition[m.selectedSes.status]||m.selectedSes.status};h({url:"force-state-session",method:"post",data:w}).success(function(){m.shared.updateSesData()})}else{var w={sesid:m.selectedSes.id};h({url:"change-state-session",method:"post",data:w}).success(function(){m.shared.updateSesData()})}}}),adpp.controller("NewUsersController",function(g,h,l){var m=g;m.addToSession=function(){if(0==m.newMembs.length)return void l.error("No hay usuarios seleccionados para agregar");var w={users:m.newMembs.map(function(x){return x.id}),sesid:m.selectedSes.id};h({url:"add-ses-users",method:"post",data:w}).success(function(x){"ok"==x.status&&(m.getNewUsers(),m.getMembers())})},m.removeUser=function(w){if(1==m.selectedSes.status){var x={uid:w,sesid:m.selectedSes.id};h({url:"delete-ses-user",method:"post",data:x}).success(function(y){"ok"==y.status&&(m.getNewUsers(),m.getMembers())})}}}),adpp.controller("SemDocController",function(g,h,l){var m=g;m.newSDoc={id:null,title:"",content:""},m.addSemDoc=function(){var o={sesid:m.selectedSes.id,title:m.newSDoc.title,content:m.newSDoc.content};h({url:"add-semantic-document",method:"post",data:o}).success(function(w){"ok"==w.status&&(m.requestSemDocuments(),l.success("Texto agregado correctamente"),m.newSDoc={id:null,title:"",content:""})})},m.deleteText=function(o){h.post("delete-semantic-document",{id:o}).success(function(x){"ok"==x.status&&(m.requestSemDocuments(),l.success("Texto eliminado correctamente"))})},m.startEditText=function(o){m.newSDoc={id:o.id,title:o.title,content:o.content},l.info("Edite el texto en el formulario")},m.updateSemDoc=function(){if(null==m.newSDoc.id)return void l.error("No hay texto a editar.");var o={id:m.newSDoc.id,sesid:m.selectedSes.id,title:m.newSDoc.title,content:m.newSDoc.content};h({url:"update-semantic-document",method:"post",data:o}).success(function(w){"ok"==w.status&&(m.requestSemDocuments(),l.success("Texto editado correctamente."),m.newSDoc={id:null,title:"",content:""})})}}),adpp.controller("QuestionsController",function(g,h,l,m,o){var w=g;w.qsLabels=["A","B","C","D","E"],w.newQuestion={id:null,content:"",alternatives:["","","","",""],comment:"",other:"",textid:null,answer:-1},w.newText={id:null,title:"",content:""},o.getMap().then(function(x){console.log("MAP correctly loaded"),w.map=x}),w.selectAnswer=function(x){w.newQuestion.answer=x},w.addQuestion=function(){if(-1==w.newQuestion.answer)return void l.error("Debe indicar la respuesta correcta a la pregunta");var x={content:w.newQuestion.content,options:w.newQuestion.alternatives.join("\n"),comment:w.newQuestion.comment,answer:w.newQuestion.answer,sesid:w.selectedSes.id,textid:w.newQuestion.textid,other:w.newQuestion.other};h({url:"add-question",method:"post",data:x}).success(function(y){"ok"==y.status&&(w.requestQuestions(),l.success("Pregunta agrgada correctamente"),w.newQuestion={id:null,content:"",alternatives:["","","","",""],comment:"",other:"",textid:null,answer:-1},w.shared.sendOverlayBuffer(y.id))})},w.updateQuestion=function(){if(null==w.newQuestion.id)return void l.error("No hay pregunta para editar");if(-1==w.newQuestion.answer)return void l.error("Debe indicar la respuesta correcta a la pregunta");var x={id:w.newQuestion.id,content:w.newQuestion.content,options:w.newQuestion.alternatives.join("\n"),comment:w.newQuestion.comment,answer:w.newQuestion.answer,sesid:w.selectedSes.id,textid:w.newQuestion.textid,other:w.newQuestion.other};h({url:"update-question",method:"post",data:x}).success(function(y){"ok"==y.status&&(w.requestQuestions(),l.success("Pregunta editada correctamente"),w.newQuestion={id:null,content:"",alternatives:["","","","",""],comment:"",other:"",textid:null,answer:-1})})},w.startEditQuestion=function(x){w.newQuestion={id:x.id,content:x.content,alternatives:x.options,comment:x.comment,other:x.other,textid:x.textid,answer:x.answer},l.info("Edite la pregunta en el formulario.")},w.startEditText=function(x){w.newText={id:x.id,title:x.title,content:x.content},l.info("Edite el texto en el formulario.")},w.addQuestionText=function(){var x={sesid:w.selectedSes.id,title:w.newText.title,content:w.newText.content};h({url:"add-question-text",method:"post",data:x}).success(function(y){"ok"==y.status&&(w.requestQuestions(),w.newText={id:null,title:"",content:""})})},w.updateQuestionText=function(){if(null==w.newText.id)return void l.error("No hay texto para editar");var x={id:w.newText.id,sesid:w.selectedSes.id,title:w.newText.title,content:w.newText.content};h({url:"update-question-text",method:"post",data:x}).success(function(y){"ok"==y.status&&(w.requestQuestions(),w.newText={title:"",content:""})})},w.deleteQuestion=function(x){h.post("delete-question",{id:x}).success(function(){w.requestQuestions(),l.success("Pregunta eliminada correctamente")})},w.deleteQuestionText=function(x){h.post("delete-question-text",{id:x}).success(function(){w.requestQuestions(),l.success("Texto eliminado correctamente")})},w.configQuillExtra=function(x){w.editor=x,x.getModule("toolbar").addHandler("map",function(){var y=this,z=this.quill.getSelection();if(z){w.shared.clearOverlayBuffer&&w.shared.clearOverlayBuffer();var A=m.open({templateUrl:"templ/map-selection.html",controller:"MapSelectionModalController",controllerAs:"vm",size:"lg",scope:w});A.rendered.then(function(){google.maps.event.trigger(w.map,"resize")}),A.result.then(function(B){if(null==w.map)return void o.getMap().then(function(G){console.log("MAP correctly loaded"),w.map=G;var H=w.map.getCenter().lat(),I=w.map.getCenter().lng(),J=w.map.getZoom(),K="MAP "+H+" "+I+" "+J+(B.nav?" NAV":"")+(B.edit?" EDIT":"");y.quill.insertEmbed(z.index,"code-block",""),y.quill.insertText(z.index,K)},function(){l.error("Ocurrio un error al cargar los datos del mapa, intente nuevamente.")});var C=w.map.getCenter().lat(),D=w.map.getCenter().lng(),E=w.map.getZoom(),F="MAP "+C+" "+D+" "+E+(B.nav?" NAV":"")+(B.edit?" EDIT":"");y.quill.insertEmbed(z.index,"code-block",""),y.quill.insertText(z.index,F)})}g.$apply()})}}),adpp.controller("DashboardController",function(g,h,l,m,o){var w=g;w.iterationIndicator=1,w.currentTimer=null,w.showCf=!1,w.shared.resetGraphs=function(){null!=w.selectedSes&&"L"==w.selectedSes.type?w.iterationIndicator=Math.max(Math.min(6,w.selectedSes.status-2),0):"S"==w.selectedSes.type?w.iterationIndicator=Math.max(Math.min(3,w.selectedSes.status-1),1):"M"==w.selectedSes.type&&(w.iterationIndicator=Math.max(Math.min(6,w.selectedSes.status-2),0)),w.alumState=null,w.barOpts={chart:{type:"multiBarChart",height:320,x:function(x){return x.label},y:function y(x){return x.value},showControls:!1,showValues:!1,duration:500,xAxis:{showMaxMin:!1},yAxis:{axisLabel:"Cantidad Alumnos"}}},w.barData=[{key:"Alumnos",color:"#4d6b87",values:[]}],w.updateState(),9>w.selectedSes.status&&w.reload(!0)},w.reload=function(x){x||w.updateState(),null!=w.currentTimer&&l.cancel(w.currentTimer),w.currentTimer=l(w.reload,1e3*DASHBOARD_AUTOREALOD_TIME)},w.updateState=function(){4>=w.iterationIndicator?w.updateStateIni():w.updateStateRub()},w.shared.updateState=w.updateState,w.updateStateIni=function(){w.alumTime={};var x={sesid:w.selectedSes.id,iteration:w.iterationIndicator};"S"==w.selectedSes.type?(h({url:"get-alum-full-state-sel",method:"post",data:x}).success(function(y){for(var z in w.alumState={},w.users)"A"==w.users[z].role&&(w.alumState[z]={});y.forEach(function(z){null==w.alumState[z.uid]?(w.alumState[z.uid]={},w.alumState[z.uid][z.qid]=z.correct):w.alumState[z.uid][z.qid]=z.correct}),3==w.iterationIndicator&&h({url:"get-original-leaders",method:"post",data:{sesid:w.selectedSes.id}}).success(function(z){var A=angular.copy(w.alumState);w.alumState={},w.leaderTeamStr={},z.forEach(function(B){w.alumState[B.leader]=A[B.leader],w.leaderTeamStr[B.leader]=B.team.map(function(C){return w.users[C]?w.users[C].name:"- "}).join(", ")})}),w.shared.alumState=w.alumState}),h({url:"get-alum-state-sel",method:"post",data:x}).success(function(y){var z=y.map(function(A){return A.score/=w.questions.length,A});w.buildBarData(z)}),h({url:"get-alum-confidence",method:"post",data:x}).success(function(y){w.confidence={},y.forEach(function(z){w.confidence[z.qid]||(w.confidence[z.qid]={}),w.confidence[z.qid][z.conf]=z.freq})})):"L"==w.selectedSes.type?(h({url:"get-alum-state-lect",method:"post",data:x}).success(function(y){for(var z in w.alumState={},w.users)"A"==w.users[z].role&&(w.alumState[z]={});y.forEach(function(z){w.alumState[z.uid]=null==w.alumState[z.uid]?z:z}),w.buildBarData(y),w.getAlumDoneTime(x),3==w.iterationIndicator&&h({url:"get-original-leaders",method:"post",data:{sesid:w.selectedSes.id}}).success(function(z){var A=angular.copy(w.alumState);w.alumState={},w.leaderTeamStr={},z.forEach(function(B){w.alumState[B.leader]=A[B.leader],w.leaderTeamStr[B.leader]=B.team.map(function(C){return w.users[C]?w.users[C].name:"- "}).join(", ")})}),w.shared.alumState=w.alumState}),h({url:"get-ideas-progress",method:"post",data:x}).success(function(y){w.numProgress=0,w.numUsers=Object.keys(w.users).length-1;var z=3*w.documents.length;0!=z&&(y.forEach(function(A){w.numProgress+=A.count/z}),w.numProgress*=100/w.numUsers)})):"M"==w.selectedSes.type&&h({url:"get-alum-state-semantic",method:"post",data:x}).success(function(y){for(var z in w.alumState={},w.numUsers=0,w.users)"A"==w.users[z].role&&(w.alumState[z]={},w.numUsers++);y.forEach(function(z){w.alumState[z.uid]=null==w.alumState[z.uid]?z:z}),w.buildBarData(y),w.getAlumDoneTime(x),3==w.iterationIndicator&&h({url:"get-original-leaders",method:"post",data:{sesid:w.selectedSes.id}}).success(function(z){var A=angular.copy(w.alumState);w.alumState={},w.leaderTeamStr={},z.forEach(function(B){w.alumState[B.leader]=A[B.leader],w.leaderTeamStr[B.leader]=B.team.map(function(C){return w.users[C]?w.users[C].name:"- "}).join(", ")})}),w.shared.alumState=w.alumState})},w.avgAlum=function(x){if(null!=w.alumState&&null!=w.alumState[x]){var y=0,z=0;for(var A in w.alumState[x])w.alumState[x][A]&&z++,y++;return 0<y?100*z/y:0}return 0},w.avgPreg=function(x){if(null!=w.alumState){var y=0,z=0;for(var A in w.alumState)null!=w.alumState[A]&&null!=w.alumState[A][x]&&(w.alumState[A][x]&&z++,y++);return 0<y?100*z/y:0}return 0},w.avgAll=function(){var x=0,y=0;if(null!=w.alumState)for(var z in w.alumState)for(var A in w.alumState[z])w.alumState[z][A]&&y++,x++;return 0<x?100*y/x:0},w.progress=function(){var x=0;if(null!=w.alumState){for(var y in w.alumState)for(var z in w.alumState[y])x++;return 100*x/(Object.keys(w.alumState).length*w.questions.length)}return 0},w.progressAlum=function(x){var y=0;if(null!=w.alumState&&null!=w.alumState[x]){for(var z in w.alumState[x])y++;return 100*y/w.questions.length}return 0},w.progressPreg=function(x){var y=0;if(null!=w.alumState){for(var z in w.alumState)null!=w.alumState[z][x]&&y++;return 100*y/Object.keys(w.alumState).length}return 0},w.lectPerformance=function(){var x=0,y=0;if(null!=w.alumState){for(var A in w.alumState){var z=w.alumState[A];x++,y+=z.score}return 100*y/x}return 0},w.getAlumDoneTime=function(x){h({url:"get-alum-done-time",method:"post",data:x}).success(function(y){w.numComplete=0,y.forEach(function(z){w.numComplete+=1,null==w.alumState[z.uid]?w.alumState[z.uid]=z:w.alumState[z.uid].dtime=~~z.dtime})})},w.buildBarData=function(x){var y=5;w.barData[0].values=[];for(var A,z=0;z<y;z++)A=20*z+"% - "+20*(z+1)+"%",w.barData[0].values.push({label:A,value:0});x.forEach(function(z){var A=Math.min(Math.floor(y*z.score),y-1);w.barData[0].values[A].value+=1}),w.barOpts.chart.xAxis.axisLabel="Rendimiento"},w.updateStateRub=function(){5==w.iterationIndicator?w.computeDif():6==w.iterationIndicator&&w.getAllReportResult()},w.showName=function(x){return x.example?x.title+" - Texto ejemplo":x.id+" - Reporte de Alumno "+w.users[x.uid].name},w.shared.getReports=function(){var x={sesid:w.selectedSes.id};h({url:"get-report-list",method:"post",data:x}).success(function(y){w.reports=y,w.exampleReports=y.filter(function(z){return z.example})})},w.getReportResult=function(){var x={repid:w.selectedReport.id};h({url:"get-report-result",method:"post",data:x}).success(function(y){w.result=y,w.updateState()})},w.getAllReportResult=function(){var x={sesid:w.selectedSes.id};h({url:"get-report-result-all",method:"post",data:x}).success(function(y){for(var z in w.resultAll={},w.users)"A"==w.users[z].role&&(w.resultAll[z]=[]);y.forEach(function(z){if(null!=z&&0<z.length){var A=w.getReportAuthor(z[0].rid);-1!=A&&null==w.resultAll[A]?w.resultAll[A]=z:-1!=A&&(w.resultAll[A]=z)}}),w.pairArr=y[0]?Array(y[0].length):[],w.buildRubricaBarData(y)})},w.buildRubricaBarData=function(x){var y=3,z=["Inicio-Proceso","Proceso-Competente","Competente-Avanzado"];w.barData[0].values=[];for(var B,A=0;A<y;A++)B=A+1+" - "+(A+2)+" ("+z[A]+")",w.barData[0].values.push({label:B,value:0});x.forEach(function(A){var B=A.reduce(function(D,E){return D+E.val},0)/A.length,C=Math.min(Math.floor(B-1),y-1);w.barData[0].values[C].value+=1}),w.barOpts.chart.xAxis.axisLabel="Distribuci\xF3n de Puntaje (Nivel)"},w.computeDif=function(){w.result&&function(){var x=w.result.findIndex(function(y){return"P"==w.users[y.uid].role});-1!=x&&function(){var y=w.result[x].val,z=[];w.result.forEach(function(A,B){B!=x&&z.push(Math.abs(y-A.val))}),w.buildRubricaDiffData(z)}()}()},w.buildRubricaDiffData=function(x){console.log("difs",x);var y=5,z=["Alto","Medio Alto","Medio","Medio Bajo","Bajo"];w.barData[0].values=[];for(var A=0;A<y;A++)w.barData[0].values.push({label:z[A],value:0});x.forEach(function(A){var B=Math.min(Math.floor(2*A),y-1);w.barData[0].values[B].value+=1}),w.barOpts.chart.xAxis.axisLabel="Cercan\xEDa a evaluaci\xF3n correcta"},w.getReportAuthor=function(x){if(w.reports){var y=w.reports.find(function(z){return z.id==x});return y?y.uid:-1}return-1},w.getAvg=function(x){if(null==x||0==x.length)return"";var y=x.reduce(function(z,A){return z+A.val},0);return y/x.length},w.getInMax=function(x){if(null==x)return[];var y=0;for(var z in x)y=Math.max(y,x[z].length);return Array(y)},w.showReport=function(x){h({url:"get-report",method:"post",data:{rid:x}}).success(function(z){var A={report:z,criterios:w.shared.obtainCriterios()};A.report.author=w.users[z.uid];var B={repid:z.id};h({url:"get-report-result",method:"post",data:B}).success(function(C){A.answers=C,h.post("get-criteria-selection-by-report",B).success(function(D){A.answersRubrica={},D.forEach(function(E){null==A.answersRubrica[E.uid]&&(A.answersRubrica[E.uid]={}),A.answersRubrica[E.uid][E.cid]=E.selection}),h.post("get-report-evaluators",B).success(function(E){E.forEach(function(F){var G=A.answers.findIndex(function(H){return H.uid==F.uid});-1==G?A.answers.push({uid:F.uid,evaluatorName:w.users[F.uid].name}):A.answers[G].evaluatorName=w.users[F.uid].name}),m.open({templateUrl:"templ/report-details.html",controller:"ReportModalController",controllerAs:"vm",size:"lg",scope:w,resolve:{data:function data(){return A}}})})})})})},w.showReportByUid=function(x){console.log(x);var y={uid:x,sesid:w.selectedSes.id};h({url:"get-report-uid",method:"post",data:y}).success(function(z){var A={report:z};A.report.author=w.users[x],m.open({templateUrl:"templ/report-details.html",controller:"ReportModalController",controllerAs:"vm",scope:w,resolve:{data:function data(){return A}}})})},w.broadcastReport=function(x){var y={sesid:w.selectedSes.id,rid:x};h({url:"set-eval-report",method:"post",data:y}).success(function(){o.success("Reporte enviado a alumnos")})},w.showDetailAnswer=function(x,y,z){var A=["A","B","C","D","E"];h({url:"get-selection-comment",method:"post",data:{uid:y,qid:x,iteration:z}}).success(function(C){var D=w.questions.reduce(function(G,H){return H.id==x?H:G},null);console.log(D);var E=A[C.answer]+". "+D.options[C.answer],F=D.content;m.open({templateUrl:"templ/content-dialog.html",controller:"ContentModalController",controllerAs:"vm",scope:w,resolve:{data:function data(){return C.title="Respuesta de "+w.users[y].name,C.content="Pregunta:\n"+F+"\n\nRespuesta:\n"+E+"\n\nComentario:\n"+C.comment,C.confidence&&(C.content+="\n\nGrado de Confianza: "+C.confidence+"%"),C}}})})}}),adpp.controller("MapSelectionModalController",function(g,h){var l=this;l.nav=!0,l.edit=!1,l.cancel=function(){h.dismiss("cancel")},l.resolve=function(){h.close({nav:l.nav,edit:l.edit})}}),adpp.controller("ReportModalController",function(g,h,l){var m=this;m.data=l,m.cancel=function(){h.dismiss("cancel")}}),adpp.controller("ContentModalController",function(g,h,l){var m=this;m.data=l,m.cancel=function(){h.dismiss("cancel")}}),adpp.controller("DuplicateSesModalController",function(g,h,l,m){var o=this;o.data=m,o.nses={name:o.data.name,tipo:o.data.type,descr:o.data.descr,originalSesid:o.data.id,copyDocuments:!1,copyIdeas:!1,copyQuestions:!1,copyRubrica:!1,copyUsers:!1,copySemUnits:!1,copySemDocs:!1},o.cancel=function(){l.dismiss("cancel")},o.sendDuplicate=function(){console.log(o.nses),h({url:"duplicate-session",method:"post",data:o.nses}).success(function(w){console.log(w),window.location.reload()})}}),adpp.controller("GroupController",function(g,h,l){var m=g;m.methods=["Aleatorio","Rendimiento Homogeneo","Rendimiento Heterogeneo","Tipo Aprendizaje Homogeneo","Tipo Aprendizaje Heterogeoneo"],m.lastI=-1,m.lastJ=-1,m.shared.verifyGroups=function(){m.groupNum=3,m.groupMet=m.methods[0],m.groups=[],m.groupNames=[],null!=m.selectedSes&&m.selectedSes.grouped&&(m.groupNum=null,m.groupMet=null,m.generateGroups(!0))},m.generateGroups=function(o){if(m.selectedSes.grouped)return void h({url:"group-proposal-sel",method:"post",data:{sesid:m.selectedSes.id}}).success(function(y){m.groups=y,console.log(y)});if(null==o&&(1>m.groupNum||m.groupNum>m.users.length))return void l.error("Error en los par\xE1metros de formaci\xF3n de grupos");({sesid:m.selectedSes.id,gnum:m.groupNum,method:m.groupMet});console.log(m.shared.alumState);var x=Object.values(m.users).filter(function(y){return"A"==y.role});if(console.log(x),"Tipo Aprendizaje Homogeneo"==m.groupMet||"Tipo Aprendizaje Heterogeoneo"==m.groupMet)m.groups=generateTeams(x,habMetric,m.groupNum,isDifferent(m.groupMet));else if("Aleatorio"==m.groupMet){var y=x.map(function(z){return z.rnd=Math.random(),z});m.groups=generateTeams(y,function(z){return z.rnd},m.groupNum,!1)}else if("S"==m.selectedSes.type){var y=[];for(var z in m.shared.alumState){var A=0;for(var B in m.shared.alumState[z])A+=+B;y.push({uid:z,score:A})}m.groups=generateTeams(y,function(z){return z.score},m.groupNum,isDifferent(m.groupMet))}else("L"==m.selectedSes.type||"M"==m.selectedSes.type)&&(m.groups=generateTeams(m.shared.alumState,function(y){return y.score},m.groupNum,isDifferent(m.groupMet)));null!=m.groups&&(m.groupsProp=angular.copy(m.groups),m.groupNames=[])},m.acceptGroups=function(){if(null==m.groupsProp)return void l.error("No hay propuesta de grupos para fijar");var o={sesid:m.selectedSes.id,groups:JSON.stringify(m.groups.map(function(w){return w.map(function(x){return x.uid||x.id})}))};console.log(o),h({url:"set-groups",method:"post",data:o}).success(function(w){"ok"==w.status&&(console.log("Groups accepted"),m.selectedSes.grouped=!0,m.shared.verifyGroups())})},m.swapTable=function(o,w){if(console.log(o,w,m.groups),-1==m.lastI&&-1==m.lastJ)return m.lastI=o,void(m.lastJ=w);if(m.lastI!=o||m.lastJ!=w){var x=angular.copy(m.groupsProp[o][w]);m.groupsProp[o][w]=angular.copy(m.groupsProp[m.lastI][m.lastJ]),m.groupsProp[m.lastI][m.lastJ]=x}m.lastI=-1,m.lastJ=-1}}),adpp.controller("RubricaController",function(g,h){var l=g;l.criterios=[],l.newCriterio={},l.editable=!1,l.exampleReports=[],l.newExampleReport="",l.pairNum=3,l.addCriterio=function(){l.criterios.push(l.newCriterio),l.newCriterio={}},l.removeCriterio=function(m){l.criterios.splice(m,1)},l.checkSum=function(){return 100==l.criterios.reduce(function(m,o){return m+o.pond},0)},l.shared.getRubrica=function(){l.criterios=[],l.newCriterio={},l.editable=!1;var m={sesid:l.selectedSes.id};h({url:"get-admin-rubrica",method:"post",data:m}).success(function(o){0==o.length?l.editable=!0:l.criterios=o})},l.saveRubrica=function(){var m={sesid:l.selectedSes.id};h({url:"send-rubrica",method:"post",data:m}).success(function(o){"ok"==o.status&&function(){var w=o.id;l.criterios.forEach(function(x){var y=angular.copy(x);y.rid=w,h({url:"send-criteria",method:"post",data:y}).success(function(z){"ok"==z.status&&console.log("Ok")})}),l.editable=!1}()})},l.shared.getExampleReports=function(){l.exampleReports=[];var m={sesid:l.selectedSes.id};h({url:"get-example-reports",method:"post",data:m}).success(function(o){l.exampleReports=o})},l.sendExampleReport=function(){var m={sesid:l.selectedSes.id,content:l.newExampleReport.text,title:l.newExampleReport.title};h({url:"send-example-report",method:"post",data:m}).success(function(){l.newExampleReport="",l.shared.getExampleReports()})},l.setActiveExampleReport=function(m){var o={sesid:l.selectedSes.id,rid:m.id};h({url:"set-active-example-report",method:"post",data:o}).success(function(w){"ok"==w.status&&(l.exampleReports.forEach(function(x){x.active=!1}),m.active=!0)})},l.goToReport=function(m){l.setActiveExampleReport(m),window.location.href="to-rubrica?sesid="+l.selectedSes.id},l.pairAssign=function(){var m={sesid:l.selectedSes.id,rnum:+l.pairNum||3};h({url:"assign-pairs",method:"post",data:m}).success(function(o){"ok"==o.status?(l.selectedSes.paired=!0,l.errPairMsg=""):l.errPairMsg=o.msg})},l.shared.obtainCriterios=function(){return l.criterios}}),adpp.controller("OptionsController",function(g,h,l){var m=g;m.conf={},m.sesidConfig=-1,m.options=[{name:"Ocultar Cometarios",code:"J"},{name:"Grados de Certeza",code:"C"}],m.saveConfs=function(){var o={sesid:m.selectedSes.id,options:m.buildConfStr()};h.post("update-ses-options",o).success(function(w){"ok"==w.status&&(l.success("Opciones actualizadas"),m.selectedSes.options=o.options)})},m.updateConf=function(){if(m.selectedSes.id!=m.sesidConfig){m.conf={};for(var w=m.selectedSes.options||"",o=0;o<w.length;o++)m.conf[w[o]]=!0;m.sesidConfig=m.selectedSes.id}return!0},m.buildConfStr=function(){var o="";for(var w in m.conf)m.conf[w]&&(o+=w);return o}}),adpp.controller("DashboardRubricaController",function(g){var l=g;l.reports=[],l.result=[],l.selectedReport=null,l.shared.resetRubricaGraphs=function(){l.alumState=null,l.barOpts={chart:{type:"multiBarChart",height:320,x:function x(m){return m.label},y:function y(m){return m.value},showControls:!1,showValues:!1,duration:500,xAxis:{showMaxMin:!1},yAxis:{axisLabel:"Cantidad Alumnos"}}},l.barData=[{key:"Alumnos",color:"#ef6c00",values:[]}]},l.shared.resetRubricaGraphs()}),adpp.controller("GeoAdminController",["$scope","$http","NgMap",function(g,h,l){var m=g;m.openRight=!1,m.rightTab="",m.mOverlays=[],m.sOverlays=[],m.selectedOverlay=null,m.overlayBuffer=[];var w=function toOverlay(B){return{id:B.id,name:B.name,description:B.description,color:x(B),type:B.type,fullType:z(B.type),geom:JSON.parse(B.geom)}},x=function getColor(){return"blue"},y=function packOverlay(B){return{name:B.name,description:B.description,iteration:0,qid:null==m.questions[m.selectedQs]?-1:m.questions[m.selectedQs].id,type:B.type,geom:JSON.stringify(B.geom)}},z=function getFullType(B){return"M"===B?"marker":"P"===B?"polygon":"L"===B?"polyline":"R"===B?"rectangle":"C"===B?"circle":"I"===B?"image":void 0};m.clearOverlay=function(){m.newOverlay={name:"",description:"",color:"blue",type:"M",fullType:"marker",geom:{position:null,radius:null,center:null,path:null,bounds:null}}},m.updateOverlayList=function(){var B={qid:null==m.questions[m.selectedQs]?-1:m.questions[m.selectedQs].id};h.post("list-overlay",B).success(function(C){var D=C.map(w);m.mOverlays=D.filter(function(E){return"M"==E.type}),m.sOverlays=D.filter(function(E){return"M"!=E.type})})},m.shared.updateOverlayList=m.updateOverlayList,m.onMapOverlayCompleted=function(B){m.map.mapDrawingManager[0].setDrawingMode(null),m.newOverlay.fullType=B.type,m.newOverlay.type="polyline"==B.type?"L":B.type[0].toUpperCase(),m.newOverlay.geom.position=B.overlay.getPosition?positionToArray(B.overlay.getPosition()):null,m.newOverlay.geom.radius=B.overlay.radius,m.newOverlay.geom.center=positionToArray(B.overlay.center),m.newOverlay.geom.path=B.overlay.getPath?mutiplePositionToArray(B.overlay.getPath()):null,m.newOverlay.geom.bounds=B.overlay.getBounds?boundsToArray(B.overlay.getBounds()):null,m.newOverlay.centroid=centroidAsLatLng(m.newOverlay.type,m.newOverlay.geom),m.map.showInfoWindow("iw2"),B.overlay.setMap(null)},m.colorizeShape=function(B){m.map.shapes&&m.map.shapes.nshp&&(m.map.shapes.nshp.set("fillColor",B),m.map.shapes.nshp.set("strokeColor","dark"+B))},m.closeOverlay=function(){m.clearOverlay(),m.map.infoWindows.iw2.close()};var A=function updateOverlay(){var B="M"==m.newOverlay.type?m.map.markers.nmkr:m.map.shapes.nshp;m.newOverlay.geom.position=B.getPosition?positionToArray(B.getPosition()):null,m.newOverlay.geom.radius=B.radius,m.newOverlay.geom.center=positionToArray(B.center),m.newOverlay.geom.path=B.getPath?mutiplePositionToArray(B.getPath()):null,m.newOverlay.geom.bounds=B.getBounds?boundsToArray(B.getBounds()):null,m.newOverlay.centroid=centroidAsLatLng(m.newOverlay.type,m.newOverlay.geom)};m.sendOverlay=function(){A(),m.overlayBuffer.push(y(m.newOverlay)),console.log(m.overlayBuffer),"M"==m.newOverlay.type?m.mOverlays.push(m.newOverlay):m.sOverlays.push(m.newOverlay),m.closeOverlay()},m.shared.clearOverlayBuffer=function(){m.overlayBuffer=[]},m.shared.sendOverlayBuffer=function(B){console.log(B,m.overlayBuffer),m.overlayBuffer.forEach(function(C){C.qid=B,h.post("add-overlay",C).success(function(){console.log("OK")})})},m.clickOverlay=function(){m.selectOverlay(this.id)},m.selectOverlay=function(B){m.selectedOverlay=m.mOverlays.find(function(C){return C.id==B})||m.sOverlays.find(function(C){return C.id==B}),m.selectedOverlay.centroid=centroidAsLatLng(m.selectedOverlay.type,m.selectedOverlay.geom),m.map.panTo(m.selectedOverlay.centroid),m.map.showInfoWindow("iw")},m.googleSearch=function(){var B=this.getPlace();null==B||null==B.geometry||null==B.geometry.location||(m.map.mapDrawingManager[0].setDrawingMode(null),m.newOverlay.fullType="marker",m.newOverlay.type="M",m.newOverlay.geom.position=positionToArray(B.geometry.location),m.map.panTo(B.geometry.location))},function init(){m.updateOverlayList(),m.clearOverlay(),l.getMap().then(function(B){console.log("MAP cargado correctamente"),m.map=B,m.map.streetView.setOptions({addressControlOptions:{position:google.maps.ControlPosition.TOP_CENTER}}),m.map.infoWindows.iw.close()})}()}]),adpp.filter("htmlExtractText",function(){return function(g){return g?(g+"").replace(/<[^>]+>/gm,""):""}});var generateTeams=function(g,h,l,m){if(null==l||0==l)return[];var o=g;o.sort(function(A,B){return h(B)-h(A)});for(var w=[],x=g.length/l,A=0;A<x;A++)m?function(){for(var B=[],C=o.length/l,D=0;D<l;D++)B.push(~~(Math.random()*C+C*D));w.push(o.filter(function(D,E){return B.includes(E)})),o=o.filter(function(D,E){return!B.includes(E)})}():(w.push(o.filter(function(B,C){return C<l})),o=o.filter(function(B,C){return C>=l}));for(var y=[],z=0,A=0;A<w.length;A++)1<w[A].length||0==y.length?y.push(w[A]):(y[z%y.length].push(w[A][0]),z++);return y},isDifferent=function(g){return"Rendimiento Homogeneo"!==g&&(!("Rendimiento Heterogeneo"!==g)||"Tipo Aprendizaje Homogeneo"!==g&&!("Tipo Aprendizaje Heterogeoneo"!==g))},habMetric=function(g){switch(g.aprendizaje){case"Teorico":return-2;case"Reflexivo":return-1;case"Activo":return 1;case"Pragmatico":return 2;}return 0},quillMapHandler=function(){alert("Mapa s\xF3lo disponible para preguntas")},positionToArray=function(g){return null==g?null:[g.lat(),g.lng()]},mutiplePositionToArray=function(g){for(var m,h=[],l=0;l<g.getLength();l++)m=g.getAt(l),h.push(positionToArray(m));return h},boundsToArray=function(g){return[positionToArray(g.getSouthWest()),positionToArray(g.getNorthEast())]},avgCoord=function(g){for(var h=0,l=0,m=0;m<g.length;m++)h+=g[m][0],l+=g[m][1];return[h/g.length,l/g.length]},centroidAsLatLng=function(g,h){var l=centroid(g,h);return new google.maps.LatLng(l[0],l[1])},centroid=function(g,h){return"M"==g?h.position:"C"==g?h.center:"R"==g?avgCoord(h.bounds):"P"==g||"L"==g?avgCoord(h.path):null};
