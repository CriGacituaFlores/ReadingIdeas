"use strict";var app=angular.module("Rubrica",["ui.bootstrap","btford.socket-io","timer"]);app.factory("$socket",["socketFactory",function(a){return a()}]),app.controller("RubricaController",["$scope","$http","$socket","$uibModal",function(a,b,c,d){var f=a;f.criterios=[],f.reports=[],f.report=null,f.selectedIndex=-1,f.iteration=-1,f.myUid=-1,f.sesStatusses=["Lectura","Individual","An\xF3nimo","Grupal","Reporte",".","Evaluaci\xF3n de Pares","Finalizada"],f.canAnswer=!0,f.miters=0,f.commentError=!1,f.init=function(){f.getReports(),f.getRubrica(),c.on("stateChange",function(g){console.log("SOCKET.IO",g),g.ses==f.sesId&&f.getReports()}),c.on("reportChange",function(g){console.log("SOCKET.IO",g),g.ses==f.sesId&&f.getReports()}),c.on("reportReceived",function(g){console.log("SOCKET.IO",g),g.ses==f.sesId&&f.openReport(g)}),b({url:"data/instructions.json",method:"get"}).success(function(g){f.instructions=g})},f.getReports=function(){b({url:"get-ses-info",method:"post"}).success(function(g){f.iteration=g.iteration,f.sesId=g.id,f.myUid=g.uid,f.sesSTime=null==g.stime?null:new Date(g.stime),f.sesDescr=4>f.iteration?g.descr.split("\n")[0]||g.descr:g.descr.split("\n")[1]||g.descr,"M"==g.type&&(f.sesStatusses=["Individual","Grupal","Reporte","Evaluaci\xF3n de Pares","Finalizada"],f.miters=1),5>=f.iteration?b({url:"get-active-example-report",method:"post"}).success(function(h){f.reports=[h],f.report=h,f.selectedIndex=0,f.fillSelections()}):6==f.iteration?b({url:"get-paired-report",method:"post"}).success(function(h){f.reports=h,f.report=h[0],f.selectedIndex=0,f.fillSelections()}):7==f.iteration&&b({url:"get-my-report",method:"post"}).success(function(h){console.log(h),f.reports=[h],f.report=h,f.selectedIndex=0,f.getEvals(h.id)})})},f.selectReport=function(g){f.selectedIndex=g,f.report=f.reports[g]},f.getRubrica=function(){b({url:"get-rubrica",method:"post"}).success(function(g){f.criterios=g})},f.checkCriteria=function(g){return null!=g&&null!=g.id&&null!=g.select&&f.criterios.reduce(function(h,j){return null!=g.select[j.id]&&h},!0)},f.sendSelection=function(g){if(""==g.comment||null==g.comment||5>g.comment.length)return void(f.commentError=!0);if(f.checkCriteria(g)){f.commentError=!1,f.criterios.forEach(function(j){var k={cid:j.id,sel:g.select[j.id],rid:g.id};b({url:"send-criteria-selection",method:"post",data:k}).success(function(){console.log("ok")})});var h={rid:g.id,text:g.comment};if(b({url:"send-report-comment",method:"post",data:h}).success(function(){console.log("ok")}),g.status="SENT",5==f.iteration){f.canAnswer=!1;var j={rid:g.id};b({url:"get-criteria-answer",method:"post",data:j}).success(function(k){var l=f.reports.findIndex(function(m){return m.id==g.id});console.log(l),f.reports[l].truev={},k.forEach(function(m){f.reports[l].truev[m.cid]=m.selection})})}}},f.fillSelections=function(){f.reports.forEach(function(g){var h={rid:g.id};f.canAnswer=!0,b({url:"get-criteria-selection",method:"post",data:h}).success(function(j){g.select={},j.forEach(function(k){g.select[k.cid]=k.selection,5==f.iteration&&(f.canAnswer=!1)})}),b({url:"get-report-comment",method:"post",data:h}).success(function(j){g.comment=j.comment})})},f.getEvals=function(g){var h={repid:g};b({url:"get-report-result",method:"post",data:h}).success(function(j){f.answers=j}),b.post("get-criteria-selection-by-report",h).success(function(j){f.answersRubrica={},j.forEach(function(k){null==f.answersRubrica[k.uid]&&(f.answersRubrica[k.uid]={}),f.answersRubrica[k.uid][k.cid]=k.selection})})},f.getAvg=function(){if(null!=f.answers&&0!=f.answers.length){var g=f.answers.reduce(function(h,j){return h+j.val},0);return g/f.answers.length}},f.openReport=function(g){var h={rid:g.rid};b({url:"get-report",method:"post",data:h}).success(function(j){d.open({templateUrl:"templ/report-details.html",controller:"ReportModalController",controllerAs:"vm",scope:f,resolve:{report:function report(){return j}}})})},f.selectCriterio=function(g,h){f.canAnswer&&(f.report.select[g]=h)},f.init()}]),app.controller("ReportModalController",["$scope","$uibModalInstance","report",function(a,b,c){var d=this;d.report=c,d.cancel=function(){b.dismiss("cancel")}}]);
