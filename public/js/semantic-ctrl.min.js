"use strict";var app=angular.module("Semantic",["ui.tree","btford.socket-io","timer","ui-notification"]);app.factory("$socket",["socketFactory",function(c){return c()}]),app.controller("SemanticController",["$scope","$http","$timeout","$socket","Notification",function(c,d,f,g,h){var k=c;k.iteration=0,k.sesStatusses=[{i:1,name:"Individual"},{i:3,name:"Grupal"},{i:4,name:"Reporte"},{i:5,name:"Evaluaci\xF3n de Pares"},{i:6,name:"Finalizada"}],k.documents=[],k.finished=!1,k.text="",k.sentences=[],k.highlight=[],k.disabledSents=[],k.originalTexts=[],k.originalSentences=[],k.sent={},k.writingReport=!1,k.followLeader=!1,k.leader=!1,k.writingReport=!1,k.views={},k.units=[],k.unitsIter1=[],k.unitsIter3=[],k.shared={},k.teamNames={},k.editing=-1,k.hgDocs={},k.init=function(){g.on("stateChange",function(l){console.log("SOCKET.IO",l),l.ses==k.sesId&&window.location.reload()}),g.on("updateTeam",function(l){k.teamId==l.tmid&&(!k.leader&&k.getUnits(),k.getTeamInfo())}),k.getSesInfo()},k.getSesInfo=function(){d({url:"get-ses-info",method:"post"}).success(function(l){k.iteration=l.iteration,k.myUid=l.uid,k.sesName=l.name,k.sesId=l.id,k.sesDescr=4>k.iteration?l.descr.split("\n")[0]||l.descr:l.descr.split("\n")[1]||l.descr,k.sesSTime=null==l.stime?null:new Date(l.stime),k.getDocuments(),3==k.iteration&&k.getTeamInfo(),3<=k.iteration&&k.getSimpleTeamInfo(),4==k.iteration&&(k.writingReport=!0),5<=k.iteration&&(k.finished=!0),6==k.iteration&&window.location.replace("rubrica"),d({url:"get-finished",method:"post",data:{status:k.iteration+2}}).success(function(m){m.finished&&(k.finished=!0)})})},k.selectDocument=function(l){k.selectedDocument==l||(k.selectedDocument=l,k.text=k.originalTexts[l],k.sentences=k.originalSentences[l])},k.countHighlight=function(){return null!=k.highlight&&k.highlight.reduce(function(l,m){return l.concat(m)},[]).reduce(function(l,m){return m?l+1:l},0)},k.getDocuments=function(){d({method:"post",url:"get-semantic-documents"}).success(function(l){k.documents=l,0<k.documents.length&&(k.processDocuments(),k.selectDocument(0),k.getUnits())})},k.processDocuments=function(){k.highlight=[],k.disabledSents=[],k.originalTexts=[],k.originalSentences=[];for(var m,l=0;l<k.documents.length;l++)m=k.documents[l].content,k.originalTexts.push(m.replace(/.[ ]+\n/,".\n")),k.originalSentences.push(k.originalTexts[l].match(/[^.!?\n]+[.!?\n]+/g)||[]),k.highlight.push(Array.from({length:k.originalSentences[l].length},function(){return!1})),k.disabledSents.push(Array.from({length:k.originalSentences[l].length},function(){return!1}))},k.processUnits=function(){for(var l=0;l<k.units.length;l++)for(var m=0;m<k.units[l].sentences.length;m++){var n=k.units[l].docs[m],o=k.units[l].sentences[m];k.disabledSents[n][o]=!0}console.table(k.disabledSents)},k.getUnits=function(){var l=3==k.iteration?"get-team-sync-units":"get-semantic-units";d({method:"post",url:l,data:{iteration:k.iteration}}).success(function(m){k.units=m,k.processUnits()}),1<k.iteration&&d({method:"post",url:"get-team-semantic-units",data:{iteration:1}}).success(function(m){k.unitsIter1=m}),3<k.iteration&&d({method:"post",url:"get-team-sync-units",data:{iteration:3}}).success(function(m){k.unitsIter3=m})},k.getHgSents=function(){return k.highlight.map(function(l){return l.map(function(n,o){return[n,o]}).filter(function(n){return n[0]}).map(function(n){return n[1]})}).reduce(function(l,m){return l.concat(m)},[])},k.getHgDocs=function(){return k.highlight.map(function(l,m){return l.map(function(n,o){return[n,o]}).filter(function(n){return n[0]}).map(function(){return m})}).reduce(function(l,m){return l.concat(m)},[])},k.addSemUnit=function(l){if(3!=k.iteration||k.leader){if(l.edit&&k.toggleEdit(-1,l),3==k.iteration&&(null==l.comment||0==l.comment.length))return void h.error("Debe ingresar un comentario.");var m=3==k.iteration?"add-sync-semantic-unit":"add-semantic-unit";null!=l.id&&(m="update-semantic-unit");var n={id:l.id,comment:l.comment,sentences:l.sentences,docs:l.docs,iteration:k.iteration,uidoriginal:k.originalLeader};console.log(n),d({method:"post",url:m,data:n}).success(function(o){l.dirty=!1,null==l.id&&(l.id=o.id),k.sent[l.id]=!0,3==k.iteration&&k.updateSignal()})}},k.updateSignal=function(){d({url:"update-my-team",method:"post"}).success(function(){console.log("Team updated")})},k.takeControl=function(){d({url:"take-team-control",method:"post"}).success(function(){console.log("Control given"),k.updateSignal()})},k.addEmptyUnit=function(){if(-1!=k.editing)return void h.error("Debe terminar de editar la unidad actual para editar otra.");k.units.push({id:null,comment:"",sentences:k.getHgSents(),status:"unsaved",docs:k.getHgDocs()});var l=k.units.length-1;k.toggleEdit(l,k.units[l])},k.finishState=function(){if(!k.finished){if(3>=k.iteration){if(0==k.units.length)return void h.error("No hay suficientes unidades sem\xE1nticas para terminar la actividad");if(!k.areAllUnitsSync())return void h.error("Hay unidades sem\xE1nticas que no han sido enviadas")}4==k.iteration&&k.shared.sendReport();var l=window.confirm("\xBFEsta seguro que desea terminar la actividad?\nEsto implica no volver a poder editar sus respuestas");if(l){var m={status:k.iteration+2};d({url:"record-finish",method:"post",data:m}).success(function(){k.hasFinished=!0,k.finished=!0,console.log("FINISH"),3==k.iteration&&k.updateSignal()})}}},k.areAllUnitsSync=function(){return k.units.every(function(l){return!l.dirty})},k.toggleEdit=function(l,m){return 3!=k.iteration||k.leader?-1==k.editing||m.edit?m.edit&&0==k.countHighlight()?void h.error("Debe seleccionar al menos una unidad sem\xE1ntica"):void(m.edit?(m.sentences=k.getHgSents(),m.docs=k.getHgDocs(),k.fillUnitDisabled(m,!0),m.edit=!1,k.editing=-1,k.unselectAllHighlights()):(m.edit=!0,k.editing=l,k.fillHighlightByUnit(m),k.fillUnitDisabled(m,!1),m.dirty=!0)):void h.error("Debe terminar de editar la unidad actual para editar otra."):void 0},k.fillUnitDisabled=function(l,m){for(var n=0;n<l.sentences.length;n++){var o=l.docs[n],p=l.sentences[n];k.disabledSents[o][p]=m}},k.startView=function(l){return l.viewing?void k.stopView(l):void(l.viewing=!0,k.views={},l.sentences.filter(function(m,n){return l.docs[n]==k.selectedDocument}).forEach(function(m){k.views[m]=!0}))},k.stopView=function(l){l.viewing=!1,k.views={}},k.fillHighlightByUnit=function(l){k.unselectAllHighlights(),k.hgDocs={};for(var o,m=!0,n=0;n<l.sentences.length;n++){o=l.docs[n],k.hgDocs[o]=!0,m&&(k.selectDocument(o),m=!1);var p=l.sentences[n];k.highlight[o][p]=!0}},k.unselectAllHighlights=function(){k.hgDocs={};for(var l=0;l<k.highlight.length;l++)for(var m=0;m<k.highlight[l].length;m++)k.highlight[l][m]=!1},k.getTeamInfo=function(){d({url:"get-team-leader",method:"post"}).success(function(l){k.teamId=l.id,k.originalLeader=l.original_leader,l.leader==k.myUid?(k.leader=!0,k.followLeader=!1):(k.leader=!1,k.followLeader=!0)}),d({url:"get-team",method:"post"}).success(function(l){k.teamstr=l.map(function(m){return m.name+(m.finished?" \u2713":"")}).join(", ")})},k.getSimpleTeamInfo=function(){d({url:"get-team",method:"post"}).success(function(l){k.teamNames={},l.forEach(function(m){k.teamNames[m.id]=m.name})})},k.deleteUnit=function(l,m){if(m.edit)return void h.error("No puede eliminar una unidad que est\xE1 siendo editada");if(null!=m.id){var n={id:m.id};d({url:"delete-semantic-unit",method:"post",data:n}).success(function(){console.log("Idea deleted"),3==k.iteration&&k.updateSignal()})}k.units.splice(l,1)},k.init()}]),app.controller("ReportController",["$scope","$http",function(c,d){var f=c;f.isFull=!0,f.content="",f.lastSent=null,f.toggleFull=function(){f.isFull=!f.isFull},f.sendReport=function(){var g={content:f.content};d({url:"send-report",method:"post",data:g}).success(function(h){"ok"==h.status&&(f.lastSent=new Date)})},f.shared.sendReport=f.sendReport,f.getReport=function(){d({url:"get-my-report",method:"post"}).success(function(g){"ok"==g.status&&(f.content=g.content,f.idReport=g.id)})},f.getReport()}]);var indexById=function(c,d){return c.findIndex(function(f){return f.id==d})};
